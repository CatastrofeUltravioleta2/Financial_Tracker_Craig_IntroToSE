@page "/"
@using Microsoft.AspNetCore.Http.Features
@inject NavigationManager NavigationManager
<PageTitle>Login</PageTitle>

<style>
  /* Login page styles â€” always dark */
  :root{
    --p1:#402E7A;
    --p2:#4C3BCF;
    --p3:#4B70F5;
    --accent:#3DC2EC;
    --bg:#070712;
    --card-bg:#0A0E22;
    --text:#EAF4FF;
    --muted:#B7C7F7;
    --radius:14px;
    --input-border: rgba(255,255,255,0.03);
  }

  html, body { margin:0; height:100%; background-color:var(--bg); color:var(--text); font-family:Inter,system-ui; }

  body { display:flex; align-items:center; justify-content:center; padding: 24px; }

  #form-container {
    width:420px;
    max-width:95%;
    background: var(--card-bg);
    padding:26px;
    border-radius:var(--radius);
    border: 1px solid rgba(76,59,207,0.10);
    display:flex; flex-direction:column; gap:12px;
    margin: 32px auto;
  }

  #form-container label { display:block; margin-bottom:6px; color:var(--p2); font-weight:700; }
  #form-container input {
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--input-border);
    background:transparent;
    color:var(--text);
  }

  /* include .showButton so show/hide buttons use the same visual style */
  #submitDiv button, #modeToggle button, .showButton {
    padding:15px 14px; border-radius:10px; border:none; background-color: var(--p3); color:white; font-weight:800; cursor:pointer;
    display:inline-block; vertical-align:middle;
  }

  #usernameErrorMessage, #passwordErrorMessage, #confirmPasswordErrorMessage, #accountErrorMessage {
    color:#FF6B6B;
    font-weight:700;
    font-size:0.9rem;
  }

</style>


<body>
    <div id="Main-login">
        <div id="form-container">
            <div id="Login Setup">
                <legend>Login To Our Financial Tracker</legend>
                <div id="login_Username">
                    <label for="usernameInput">Enter Username</label>
                    <input name="usernameInput" id="usernameInput" @bind="Username" />
                    <p id="usernameErrorMessage">@UsernameError</p>
                </div>
                <div id="login_password">
                    <label for="passwordInput">Enter Password:</label>
                    <input type="@PasswordInputType" name="passwordInput" id="passwordInput" @bind="Password" />
                    <p id="passwordErrorMessage">@PasswordError</p>
                    <button type="button" class="showButton" @onclick="ShowPasswordField">@(ShowPasswordText ? "Hide" : "Show")</button>
                </div>
                @if (ShowConfirmPassword)
                {
                    <div id="confirm_login_password">
                        <label for="confirmPasswordInput">Confirm your Password:</label>
                        <input type="@ConfirmPasswordInputType" name="confirmPasswordInput" id="confirmPasswordInput"
                            @bind="ConfirmPassword" />
                        <p id="confirmPasswordErrorMessage">@ConfirmPasswordError</p>
                        <button type="button" class="showButton" @onclick="ShowConfirmPasswordField">@(ShowConfirmPasswordText ? "Hide" :
                                                    "Show")</button>
                    </div>
                }
                <div id="modeToggle">
                    @if (IsLoginMode)
                    {
                        <button type="button" @onclick="() => SwitchLoginFormat(false)">Create Account</button>
                    }
                    else
                    {
                        <button type="button" @onclick="() => SwitchLoginFormat(true)">I already Have an Account</button>
                    }
                </div>
                <div id="submitDiv">
                    <button type="button" @onclick="ValidateUser">Submit</button>
                    <p id="accountErrorMessage">@AccountError</p>
                </div>
            </div>
        </div>
    </div>
</body>


@code {
    public string Username = "";
    public string Password = "";
    public string ConfirmPassword = "";
    public static SQLuserData SQLuserDataManager = new SQLuserData();
    public static Dictionary<string, string> userData = SQLuserDataManager.GetUserData();
    public static bool isLoggedIn;
    private bool ShowConfirmPassword = false;
    private bool ShowPasswordText = false;
    private bool ShowConfirmPasswordText = false;
    private bool IsLoginMode = true;
    private string UsernameError = "";
    private string PasswordError = "";
    private string ConfirmPasswordError = "";
    private string AccountError = "";

    private string PasswordInputType => ShowPasswordText ? "text" : "password";
    private string ConfirmPasswordInputType => ShowConfirmPasswordText ? "text" : "password";

    protected override void OnInitialized()
    {
        IsLoginMode = true;
        ShowConfirmPassword = !IsLoginMode;
        ShowConfirmPasswordText = false;
    }

    private void ShowPasswordField()
    {
        ShowPasswordText = !ShowPasswordText;
    }
    private void ShowConfirmPasswordField()
    {
        ShowConfirmPasswordText = !ShowConfirmPasswordText;
    }

    private void ValidateUser()
    {
        UsernameError = PasswordError = ConfirmPasswordError = AccountError = "";

        if (string.IsNullOrWhiteSpace(Username))
        {
            UsernameError = "Username is required.";
        }
        if (string.IsNullOrWhiteSpace(Password))
        {
            PasswordError = "Password is required.";
        }


        if (ShowConfirmPassword)
        {
            if (string.IsNullOrWhiteSpace(ConfirmPassword))
            {
                ConfirmPasswordError = "Please confirm your password.";
            }
            else if (Password != ConfirmPassword)
            {
                ConfirmPasswordError = "Passwords do not match.";
            }
        }

        if (!string.IsNullOrEmpty(UsernameError) || !string.IsNullOrEmpty(PasswordError) || (ShowConfirmPassword &&
        !string.IsNullOrEmpty(ConfirmPasswordError)))
        {
            StateHasChanged();
            return;
        }


        userData = SQLuserDataManager.GetUserData();

        if (!ShowConfirmPassword)
        {
            if (userData.TryGetValue(Username, out string? storedPassword))
            {
                if (storedPassword == Password)
                {
                    isLoggedIn = true;
                    NavigationManager.NavigateTo($"/Home/{Username}");
                }
                else
                {
                    PasswordError = "Incorrect password.";
                }
            }
            else
            {
                AccountError = "No account found for that username.";
            }
        }
        else
        {
            if (userData.ContainsKey(Username))
            {
                AccountError = "An account with that username already exists.";
            }
            else
            {
                userData[Username] = Password;
                SQLuserDataManager.SaveUserData(userData);
                isLoggedIn = true;
                NavigationManager.NavigateTo($"/Home/{Username}");
            }
        }
        StateHasChanged();
    }
    private void SwitchLoginFormat(bool haveAnAccount)
    {
        IsLoginMode = haveAnAccount;
        ShowConfirmPassword = !IsLoginMode;
        ShowConfirmPasswordText = false;

        UsernameError = PasswordError = ConfirmPasswordError = AccountError = "";
        StateHasChanged();
    }

}